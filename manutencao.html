<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eng Process & Quality - CMMS Lite (Manuten√ß√£o)</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
      :root{--bg:#0f172a;--panel:#111827;--muted:#1f2937;--card:#0b1220;--text:#e5e7eb;--accent:#22d3ee;--accent2:#a78bfa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:16px;}
      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial;background:linear-gradient(120deg,#0b1020,#0a1328);color:var(--text);display:grid;grid-template-columns:280px 1fr;grid-template-rows:auto 1fr;gap:0;}
      header{grid-column:1/3;display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:linear-gradient(90deg,#0b1020,#0a1a35);border-bottom:1px solid #1e293b;position:sticky;top:0;z-index:5}
      .header-title h1{margin:0;font-size:20px;letter-spacing:.4px;color:var(--text);}.header-title .subtitle{margin:4px 0 0 0;font-size:14px;font-weight:normal;color:var(--accent);}.header-title .dev-credit{margin:4px 0 0 0;font-size:11px;font-weight:normal;color:#64748b;}
      header .actions{display:flex;flex-wrap:wrap;gap:8px}
      button, .btn{background:var(--muted);color:var(--text);border:1px solid #243041;border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow:var(--shadow);transition:.2s;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:8px;}
      button:hover, .btn:hover{transform:translateY(-1px);border-color:#334155}
      button.primary{background:linear-gradient(180deg,#0ea5e9,#2563eb);border-color:transparent}
      button.ghost{background:transparent;border-color:#334155}
      aside{border-right:1px solid #1f2937;background:linear-gradient(180deg,#0b1020,#0a1328);padding:16px;display:flex;flex-direction:column;gap:24px;justify-content:space-between; overflow-y: auto;}
      .menu{display:flex;flex-direction:column;gap:8px}
      .menu a{display:flex;gap:10px;align-items:center;text-decoration:none;color:#cbd5e1;padding:10px 12px;border:1px solid #1e293b;border-radius:12px;background:rgba(255,255,255,.02);cursor:pointer;}
      .menu a.active, .menu a:hover{border-color:#334155;background:rgba(34,211,238,.08);color:#e2e8f0}
      main{padding:18px;overflow:auto}
      .hidden, .tab-content.hidden{display:none !important}
      section{background:rgba(255,255,255,.03);border:1px solid #1f2937;border-radius:var(--radius);padding:20px;margin-bottom:20px;box-shadow:var(--shadow)}
      h2, h3, h4{margin:0 0 12px 0;color:var(--accent);} h4{color:var(--accent2)}
      .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));}
      .field{display:flex;flex-direction:column;gap:6px}
      label{font-size:12px;color:#93c5fd}
      input, select, textarea{background:#0b1220;border:1px solid #243041;color:var(--text);padding:10px 12px;border-radius:10px;outline:none;font-family:inherit;font-size:14px;min-height:44px}
      table{width:100%;border-collapse:collapse;} th, td{padding:10px 12px;border-bottom:1px solid var(--muted);text-align:left;font-size:13px;vertical-align:middle;} th{background:rgba(255,255,255,.05);font-size:12px;color:#94a3b8;}
      .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;}
      .kpi-card{background:var(--card);border-radius:12px;padding:16px;text-align:center;}
      .kpi-card h3{font-size:12px;color:var(--accent2);margin:0 0 8px 0;font-weight:normal;text-transform:uppercase;}
      .kpi-card .kpi-value{font-size:2.25rem;font-weight:bold;color:var(--accent);}
      #record-counter{background:rgba(255,255,255,.02);border:1px solid #1e293b;border-radius:12px;padding:12px;} #record-counter p{margin:8px 0;color:#cbd5e1;display:flex;justify-content:space-between;} #record-counter span{font-weight:bold;color:var(--accent);}
      .user-info{text-align:center;}
      .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:100;display:none;justify-content:center;align-items:center;padding:16px;}
      .modal.active{display:flex;}
      .modal-content{background:var(--bg);padding:24px;border-radius:16px;width:90%;max-width:800px;border:1px solid var(--muted);max-height:90vh;overflow-y:auto;}
      .toast-container{position:fixed;top:20px;right:20px;z-index:200;display:flex;flex-direction:column;gap:10px;}
      .toast{padding:12px 18px;border-radius:12px;color:white;font-weight:600;font-size:14px;box-shadow:var(--shadow);opacity:0;transform:translateX(100%);transition:all 0.4s ease;}
      .toast.show{opacity:1;transform:translateX(0);}.toast.success{background:linear-gradient(90deg,#22c55e,#16a34a);}.toast.error{background:linear-gradient(90deg,#ef4444,#dc2626);}.toast.info{background:linear-gradient(90deg,#3b82f6,#2563eb);}
      .status-pill{padding:.2rem .6rem;border-radius:99px;font-weight:600;font-size:.75rem;color:white;display:inline-block;text-align:center;}
      .autocomplete-container { position: relative; }
      .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; z-index: 10; background: var(--panel); border: 1px solid var(--muted); border-radius: 10px; max-height: 200px; overflow-y: auto; margin-top: 4px; }
      .autocomplete-item { padding: 10px 12px; cursor: pointer; font-size: 14px; text-align: left; }
      .autocomplete-item:hover { background: var(--muted); }
      .autocomplete-item.is-new { font-style: italic; color: var(--accent); }
      @media print{body{grid-template-columns:1fr;color:#000;background:#fff;}header,aside,.hidden-print,.btn,.modal{display:none!important;}main{padding:0;overflow:visible;}section{border:1px solid #ccc;box-shadow:none;background:#fff;page-break-inside:avoid;}h2,h3,h4,label,p,span{color:black !important;}}
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <header>
        <div class="header-title"><h1>Eng Process & Quality</h1><p class="subtitle">CMMS Lite (Gest√£o de Manuten√ß√£o)</p><p class="dev-credit">Desenvolvido por Marcos Gar√ßon</p></div>
        <div class="actions">
            <button class="btn ghost" id="btn-restore-backup">Restaurar Backup</button>
            <button class="btn ghost" id="btn-download-backup">Baixar Backup (.json)</button>
            <button class="btn ghost" id="btn-archive-and-clear" style="color:var(--warn);">Arquivar e Limpar</button>
            <button class="btn primary hidden-print" id="btn-export-pdf">Exportar PDF</button>
        </div>
    </header>
    <aside>
        <div>
            <div class="menu">
                <a href="#" class="tab-link active" onclick="openTab(event, 'dashboard')"><i class="ph-bold ph-gauge"></i> Dashboard</a>
                <a href="#" class="tab-link" onclick="openTab(event, 'machines')"><i class="ph-bold ph-robot"></i> M√°quinas</a>
                <a href="#" class="tab-link" onclick="openTab(event, 'preventive')"><i class="ph-bold ph-calendar-check"></i> Planos Preventivos</a>
                <a href="#" class="tab-link" onclick="openTab(event, 'workorders')"><i class="ph-bold ph-wrench"></i> Ordens de Servi√ßo</a>
                <a href="#" class="tab-link" onclick="openTab(event, 'history')"><i class="ph-bold ph-archive"></i> Hist√≥rico</a>
                <a href="#" class="tab-link" onclick="openTab(event, 'kpis')"><i class="ph-bold ph-chart-line-up"></i> KPIs & BI</a>
                <a href="#" class="tab-link" onclick="openTab(event, 'cadastros')">üó≥Ô∏è Cadastros</a>
                <a href="#" class="tab-link" onclick="openTab(event, 'help')"><i class="ph-bold ph-question"></i> Ajuda</a>
            </div>
        </div>
        <div id="record-counter">
             <p>M√°quinas: <span id="machine-count">0</span></p>
             <p>Ordens Abertas: <span id="open-os-count">0</span></p>
        </div>
        <div class="user-info">
            <p style="margin:0 0 8px 0;font-size:12px;">Usu√°rio Ativo:</p>
            <span id="current-user-display" style="color:var(--accent);font-weight:bold;">Nenhum</span>
            <button class="btn ghost" id="btn-switch-user" style="width:100%;margin-top:10px;font-size:12px;padding:5px;">Trocar Usu√°rio</button>
        </div>
    </aside>
    <main id="main-content">
        </main>
    
    <div id="login-modal" class="modal"><div class="modal-content" style="max-width: 400px;"><h3>Bem-vindo!</h3><p>Identifique-se para continuar.</p><form id="login-form" style="margin-top:12px;"><div class="field" style="text-align:left;"><label>Seu Nome</label><input id="analyst-name-input" required></div><button type="submit" class="btn primary" style="margin-top:16px;width:100%;">Entrar</button></form></div></div>
    <div id="os-modal" class="modal"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE & DB ---
        let state = {};
        const DB_KEY = 'mg_cmms_v3'; // Version up for safety
        const USER_KEY = 'currentUser_cmms_v1';
        let kpiChart = null;
        let dashboardChart = null;

        const main = document.getElementById('main-content');
        const loginModal = document.getElementById('login-modal');
        const osModal = document.getElementById('os-modal');
        const currentUserDisplay = document.getElementById('current-user-display');
        
        // --- HELPERS ---
        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container'); if(!container) return;
            const toast = document.createElement('div');
            toast.className = `toast ${type}`; toast.textContent = message; container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 4000);
        };
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return isNaN(date.getTime()) ? 'N/A' : new Date(date.valueOf() + date.getTimezoneOffset() * 60 * 1000).toLocaleDateString('pt-BR');
        };
        const formatDateTime = (dateString) => dateString ? new Date(dateString).toLocaleString('pt-BR') : 'N/A';
        const getStatusPill = (status) => {
            const colors = { Aberta: '#ef4444', 'Em Andamento': '#f59e0b', Conclu√≠da: '#22c55e', Cancelada: '#6b7280' };
            return `<span class="status-pill" style="background-color:${colors[status] || '#6b7280'}">${status}</span>`;
        };

        // --- DATA & NAVIGATION ---
        const saveData = () => { try { localStorage.setItem(DB_KEY, JSON.stringify(state)); } catch (e) { showToast('Erro ao salvar dados.', 'error'); } };
        const loadData = () => {
            try {
                const loaded = JSON.parse(localStorage.getItem(DB_KEY));
                state = {
                    machines: loaded?.machines || [],
                    preventivePlans: loaded?.preventivePlans || [],
                    workOrders: loaded?.workOrders || [],
                    technicians: loaded?.technicians || ["Equipe Mec√¢nica", "Equipe El√©trica", "Automa√ß√£o"],
                    parts: loaded?.parts || [],
                };
            } catch (e) {
                state = { machines: [], preventivePlans: [], workOrders: [], technicians: ["Equipe Mec√¢nica", "Equipe El√©trica", "Automa√ß√£o"], parts: [] };
            }
        };
        const setCurrentUser = (name) => {
            localStorage.setItem(USER_KEY, name);
            if (currentUserDisplay) currentUserDisplay.textContent = name;
            loginModal.classList.remove('active');
        };
        window.openTab = (evt, tabId) => {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            const el = document.getElementById(tabId);
            if(el) el.classList.remove('hidden');
            document.querySelectorAll('.menu a').forEach(link => link.classList.remove('active'));
            if(evt.currentTarget) evt.currentTarget.classList.add('active');
            if (tabId === 'kpis') renderKpiPage();
            if (tabId === 'dashboard') renderDashboard();
        };

        // --- CSV Functions ---
        const handleExportCSV = (dataArray, filename, headers) => {
            if (!dataArray || dataArray.length === 0) return showToast('N√£o h√° dados para exportar.', 'info');
            
            const isComplex = Array.isArray(headers);
            let csvContent = "data:text/csv;charset=utf-8,";
            
            if (isComplex) {
                csvContent += headers.join(',') + '\r\n';
                dataArray.forEach(item => {
                    const row = headers.map(header => `"${item[header] || ''}"`).join(',');
                    csvContent += row + '\r\n';
                });
            } else { // Simple array
                csvContent += 'valor\r\n';
                dataArray.forEach(item => {
                    csvContent += `"${item}"\r\n`;
                });
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('Dados exportados!', 'success');
        };

        const handleImportCSV = (stateKey, isComplex, expectedHeaders) => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    if (!confirm(`Isso ir√° ADICIONAR os dados do CSV √† lista atual de "${stateKey}". Deseja continuar?`)) return;
                    try {
                        const text = event.target.result;
                        const lines = text.trim().split(/\r\n|\n/);
                        const headerLine = lines.shift().split(',').map(h => h.trim().replace(/"/g, ''));

                        if (isComplex && JSON.stringify(headerLine) !== JSON.stringify(expectedHeaders)) {
                           return showToast(`Erro: Cabe√ßalho do CSV inv√°lido. Esperado: ${expectedHeaders.join(',')}`, 'error');
                        }
                        
                        let importedCount = 0;
                        lines.forEach(line => {
                           const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                           if(values.length === 0 || (values.length === 1 && values[0] === '')) return;

                           if (isComplex) {
                                let obj = { id: Date.now() + importedCount };
                                expectedHeaders.forEach((header, index) => {
                                    obj[header] = values[index] || '';
                                });
                                state[stateKey].push(obj);
                           } else {
                                state[stateKey].push(values[0]);
                           }
                           importedCount++;
                        });

                        saveData();
                        renderAll(); // Full re-render to update all tables
                        showToast(`${importedCount} itens importados com sucesso!`, 'success');
                    } catch (err) {
                        showToast('Erro ao processar o arquivo CSV.', 'error');
                        console.error(err);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };


        const createAutocomplete = (input, dataArray) => {
            const container = input.parentElement;
            let list = container.querySelector('.autocomplete-list');
            if (!list) { list = document.createElement('div'); list.className = 'autocomplete-list hidden'; container.appendChild(list); }
            const renderList = (filter = '') => {
                list.innerHTML = '';
                const filterLower = filter.toLowerCase();
                if (!filter) { list.classList.add('hidden'); return; }
                const matches = dataArray.filter(item => item.name.toLowerCase().includes(filterLower));
                matches.forEach(item => { const itemEl = document.createElement('div'); itemEl.className = 'autocomplete-item'; itemEl.textContent = `${item.name} (${item.tag})`; itemEl.addEventListener('mousedown', () => { input.value = item.name; list.classList.add('hidden'); }); list.appendChild(itemEl); });
                list.classList.toggle('hidden', list.children.length === 0);
            };
            input.addEventListener('input', () => renderList(input.value)); input.addEventListener('focus', () => renderList(input.value)); input.addEventListener('blur', () => setTimeout(() => list.classList.add('hidden'), 200));
        };

        // --- RENDER FUNCTIONS ---
        const renderMachinesList = () => {
            const tbody = document.getElementById('tbl-machines');
            if (!tbody) return;
            tbody.innerHTML = '';
            state.machines.forEach(m => {
                const tr = tbody.insertRow();
                tr.innerHTML = `<td>${m.tag}</td><td>${m.name}</td><td>${m.department}</td><td>${formatDate(m.installDate)}</td>`;
                const actionsCell = tr.insertCell();
                actionsCell.innerHTML = `<button class="btn ghost btn-edit-machine" data-id="${m.id}">Editar</button> <button class="btn ghost btn-delete-machine" data-id="${m.id}" style="color:var(--bad)">Excluir</button>`;
            });
        };
        
        const renderPreventiveList = () => {
            const tbody = document.getElementById('tbl-preventive');
            if (!tbody) return;
            tbody.innerHTML = '';
            state.preventivePlans.forEach(p => {
                const tr = tbody.insertRow();
                tr.innerHTML = `<td>${p.machineName}</td><td>${p.task}</td><td>${p.frequency}</td><td>${p.technician}</td>`;
                 const actionsCell = tr.insertCell();
                actionsCell.innerHTML = `<button class="btn ghost btn-gen-os" data-id="${p.id}">Gerar OS</button> <button class="btn ghost btn-edit-plan" data-id="${p.id}">Editar</button> <button class="btn ghost btn-delete-plan" data-id="${p.id}" style="color:var(--bad)">Excluir</button>`;
            });
        };

        const renderWorkOrdersList = (tableId, filterFn) => {
            const tbody = document.getElementById(tableId);
            if (!tbody) return;
            tbody.innerHTML = '';
            state.workOrders.filter(filterFn).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(wo => {
                const tr = tbody.insertRow();
                tr.innerHTML = `<td>${wo.id}</td><td>${wo.machineName}</td><td>${wo.description}</td><td>${wo.type}</td><td>${wo.priority}</td><td>${getStatusPill(wo.status)}</td><td>${formatDateTime(wo.createdAt)}</td>`;
                const actionsCell = tr.insertCell();
                actionsCell.innerHTML = `<button class="btn ghost btn-view-os" data-id="${wo.id}">Ver/Editar</button>`;
            });
        };
        
        const renderCadastros = () => {
            const renderSimpleList = (key, tableId) => {
                const tbody = document.querySelector(`#${tableId} tbody`);
                if(!tbody) return;
                tbody.innerHTML = '';
                state[key].forEach((item, index) => {
                    const tr = tbody.insertRow();
                    tr.insertCell().textContent = item;
                    tr.insertCell().innerHTML = `<button class="btn ghost" onclick="deleteCadItem('${key}', ${index})">Excluir</button>`;
                });
            };
            renderSimpleList('technicians', 'tbl-technicians');
            renderSimpleList('parts', 'tbl-parts');
        };
        
        window.deleteCadItem = (key, index) => {
            if(confirm(`Tem certeza que deseja excluir "${state[key][index]}"?`)){
                state[key].splice(index, 1);
                saveData();
                renderCadastros();
                showToast('Item exclu√≠do.', 'success');
            }
        };
        
        const updateRecordCounters = () => {
            document.getElementById('machine-count').textContent = state.machines.length;
            document.getElementById('open-os-count').textContent = state.workOrders.filter(wo => wo.status === 'Aberta' || wo.status === 'Em Andamento').length;
        };
        
        const renderDashboard = () => {
            const openOrders = state.workOrders.filter(wo => wo.status === 'Aberta').length;
            const inProgressOrders = state.workOrders.filter(wo => wo.status === 'Em Andamento').length;
            const completedLast7Days = state.workOrders.filter(wo => wo.status === 'Conclu√≠da' && new Date(wo.completedAt) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)).length;
            document.getElementById('kpi-open').textContent = openOrders;
            document.getElementById('kpi-progress').textContent = inProgressOrders;
            document.getElementById('kpi-completed').textContent = completedLast7Days;

            const ctx = document.getElementById('dashboard-chart')?.getContext('2d');
            if (!ctx) return;
            
            const osByDay = state.workOrders.reduce((acc, wo) => {
                const date = new Date(wo.createdAt).toISOString().slice(0, 10);
                acc[date] = (acc[date] || 0) + 1;
                return acc;
            }, {});

            const sortedDates = Object.keys(osByDay).sort((a,b) => new Date(a) - new Date(b));
            
            if (dashboardChart) dashboardChart.destroy();
            dashboardChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Ordens de Servi√ßo Criadas',
                        data: sortedDates.map(date => osByDay[date]),
                        borderColor: 'var(--accent)',
                        backgroundColor: 'rgba(34, 211, 238, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { scales: { x: { type: 'time', time: { unit: 'day' } }, y: { beginAtZero: true } } }
            });
        };
        
        const renderKpiPage = () => {
            const completedCorrective = state.workOrders.filter(wo => wo.status === 'Conclu√≠da' && wo.type === 'Corretiva' && wo.startedAt && wo.completedAt);
            
            // MTTR
            let totalRepairTime = 0;
            completedCorrective.forEach(wo => {
                totalRepairTime += new Date(wo.completedAt) - new Date(wo.startedAt);
            });
            const mttrMs = completedCorrective.length > 0 ? totalRepairTime / completedCorrective.length : 0;
            const mttrHours = (mttrMs / (1000 * 60 * 60)).toFixed(2);
            document.getElementById('kpi-mttr').textContent = `${mttrHours} h`;

            // MTBF
            const osByMachine = {};
            completedCorrective.forEach(wo => {
                if (!osByMachine[wo.machineName]) osByMachine[wo.machineName] = [];
                osByMachine[wo.machineName].push(wo);
            });
            
            let totalOpTime = 0;
            let failureCount = 0;
            Object.values(osByMachine).forEach(machineOs => {
                if (machineOs.length < 2) return;
                machineOs.sort((a,b) => new Date(a.completedAt) - new Date(b.completedAt));
                for (let i = 0; i < machineOs.length - 1; i++) {
                    const opTime = new Date(machineOs[i+1].createdAt) - new Date(machineOs[i].completedAt);
                    if (opTime > 0) {
                        totalOpTime += opTime;
                        failureCount++;
                    }
                }
            });
            const mtbfMs = failureCount > 0 ? totalOpTime / failureCount : 0;
            const mtbfHours = (mtbfMs / (1000 * 60 * 60)).toFixed(2);
            document.getElementById('kpi-mtbf').textContent = `${mtbfHours} h`;
            
            // Availability
            const availability = (mtbfMs > 0 || mttrMs > 0) ? (mtbfMs / (mtbfMs + mttrMs)) * 100 : 0;
            document.getElementById('kpi-availability').textContent = `${availability.toFixed(2)}%`;
            
            // Chart
            const ctx = document.getElementById('kpi-chart')?.getContext('2d');
            if(!ctx) return;

            const correctiveByMonth = completedCorrective.reduce((acc, wo) => {
                const month = new Date(wo.createdAt).toISOString().slice(0,7);
                acc[month] = (acc[month] || 0) + 1;
                return acc;
            }, {});
            
            const preventiveByMonth = state.workOrders.filter(wo => wo.status === 'Conclu√≠da' && wo.type === 'Preventiva').reduce((acc, wo) => {
                const month = new Date(wo.createdAt).toISOString().slice(0,7);
                acc[month] = (acc[month] || 0) + 1;
                return acc;
            }, {});

            const allMonths = [...new Set([...Object.keys(correctiveByMonth), ...Object.keys(preventiveByMonth)])].sort();
            
            if (kpiChart) kpiChart.destroy();
            kpiChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: allMonths,
                    datasets: [
                        { label: 'Corretivas Conclu√≠das', data: allMonths.map(m => correctiveByMonth[m] || 0), backgroundColor: 'var(--bad)'},
                        { label: 'Preventivas Conclu√≠das', data: allMonths.map(m => preventiveByMonth[m] || 0), backgroundColor: 'var(--ok)' }
                    ]
                },
                options: { scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
            });
        };
        
        // --- MASTER RENDER & HTML INJECTION ---
        const renderAll = () => {
            main.innerHTML = createViewsHTML();
            addEventListeners();
            renderDashboard();
            renderMachinesList();
            renderPreventiveList();
            renderWorkOrdersList('tbl-workorders', wo => wo.status !== 'Conclu√≠da' && wo.status !== 'Cancelada');
            renderWorkOrdersList('tbl-history', wo => wo.status === 'Conclu√≠da' || wo.status === 'Cancelada');
            renderCadastros();
            updateRecordCounters();
        };

        const createViewsHTML = () => {
            return `
                <div id="dashboard" class="tab-content">
                    <section>
                        <h2>Dashboard Operacional</h2>
                        <div class="kpi-grid">
                            <div class="kpi-card"><h3>Ordens Abertas</h3><div class="kpi-value" id="kpi-open">0</div></div>
                            <div class="kpi-card"><h3>Em Andamento</h3><div class="kpi-value" id="kpi-progress">0</div></div>
                            <div class="kpi-card"><h3>Conclu√≠das (7d)</h3><div class="kpi-value" id="kpi-completed">0</div></div>
                        </div>
                    </section>
                    <section>
                        <h4>Ordens de Servi√ßo Criadas ao Longo do Tempo</h4>
                        <canvas id="dashboard-chart" height="100"></canvas>
                    </section>
                </div>
                
                <div id="machines" class="tab-content hidden">
                    <section>
                        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                           <h2>Cadastro de M√°quinas e Ativos</h2>
                           <div class="actions hidden-print">
                               <button class="btn ghost" id="btn-import-machines">Importar (CSV)</button>
                               <button class="btn ghost" id="btn-export-machines">Exportar (CSV)</button>
                           </div>
                        </div>
                        <form id="form-machine">
                           <input type="hidden" id="machine_id">
                           <div class="grid" style="grid-template-columns: repeat(4, 1fr);">
                                <div class="field"><label for="machine_tag">TAG/C√≥digo</label><input id="machine_tag" required></div>
                                <div class="field"><label for="machine_name">Nome da M√°quina</label><input id="machine_name" required></div>
                                <div class="field"><label for="machine_department">Departamento</label><input id="machine_department"></div>
                                <div class="field"><label for="machine_installDate">Data de Instala√ß√£o</label><input id="machine_installDate" type="date"></div>
                           </div>
                           <div style="margin-top:16px; display:flex; gap:10px;">
                               <button type="submit" class="btn primary">Salvar M√°quina</button>
                               <button type="button" class="btn ghost" id="btn-clear-machine">Limpar</button>
                           </div>
                        </form>
                    </section>
                    <section>
                        <h4>M√°quinas Cadastradas</h4>
                        <div style="max-height: 400px; overflow: auto;"><table><thead><tr><th>TAG</th><th>Nome</th><th>Departamento</th><th>Instala√ß√£o</th><th>A√ß√µes</th></tr></thead><tbody id="tbl-machines"></tbody></table></div>
                    </section>
                </div>
                
                <div id="preventive" class="tab-content hidden">
                    <section>
                        <h2>Planos de Manuten√ß√£o Preventiva</h2>
                        <form id="form-preventive">
                            <input type="hidden" id="plan_id">
                            <div class="grid">
                                <div class="field autocomplete-container"><label for="plan_machineName">M√°quina</label><input id="plan_machineName" required></div>
                                <div class="field"><label for="plan_task">Tarefa</label><input id="plan_task" placeholder="Ex: Lubrificar correntes, verificar n√≠vel de √≥leo..." required></div>
                                <div class="field"><label for="plan_frequency">Frequ√™ncia</label><select id="plan_frequency"><option>Di√°ria</option><option>Semanal</option><option>Quinzenal</option><option>Mensal</option><option>Trimestral</option><option>Semestral</option><option>Anual</option></select></div>
                                <div class="field"><label for="plan_technician">Equipe Respons√°vel</label><select id="plan_technician"></select></div>
                            </div>
                            <div style="margin-top:16px; display:flex; gap:10px;">
                               <button type="submit" class="btn primary">Salvar Plano</button>
                               <button type="button" class="btn ghost" id="btn-clear-plan">Limpar</button>
                           </div>
                        </form>
                    </section>
                    <section>
                        <h4>Planos Cadastrados</h4>
                        <div style="max-height: 400px; overflow: auto;"><table><thead><tr><th>M√°quina</th><th>Tarefa</th><th>Frequ√™ncia</th><th>Equipe</th><th>A√ß√µes</th></tr></thead><tbody id="tbl-preventive"></tbody></table></div>
                    </section>
                </div>
                
                <div id="workorders" class="tab-content hidden">
                    <section>
                        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h2>Ordens de Servi√ßo em Aberto</h2>
                            <button id="btn-new-os" class="btn primary hidden-print">Nova Ordem de Servi√ßo</button>
                        </div>
                        <div style="max-height: 600px; overflow: auto;"><table><thead><tr><th>#</th><th>M√°quina</th><th>Descri√ß√£o</th><th>Tipo</th><th>Prioridade</th><th>Status</th><th>Cria√ß√£o</th><th>A√ß√µes</th></tr></thead><tbody id="tbl-workorders"></tbody></table></div>
                    </section>
                </div>
                
                <div id="history" class="tab-content hidden">
                    <section>
                        <h2>Hist√≥rico de Ordens de Servi√ßo</h2>
                        <div style="max-height: 600px; overflow: auto;"><table><thead><tr><th>#</th><th>M√°quina</th><th>Descri√ß√£o</th><th>Tipo</th><th>Prioridade</th><th>Status</th><th>Cria√ß√£o</th><th>A√ß√µes</th></tr></thead><tbody id="tbl-history"></tbody></table></div>
                    </section>
                </div>
                
                <div id="kpis" class="tab-content hidden">
                    <section>
                        <h2>Indicadores Chave de Manuten√ß√£o (KPIs)</h2>
                        <div class="kpi-grid">
                            <div class="kpi-card"><h3>MTTR (Tempo M√©dio para Reparo)</h3><div class="kpi-value" id="kpi-mttr">0 h</div></div>
                            <div class="kpi-card"><h3>MTBF (Tempo M√©dio Entre Falhas)</h3><div class="kpi-value" id="kpi-mtbf">0 h</div></div>
                            <div class="kpi-card"><h3>Disponibilidade</h3><div class="kpi-value" id="kpi-availability">0%</div></div>
                        </div>
                    </section>
                    <section>
                        <h4>Manuten√ß√µes Conclu√≠das (Corretiva vs. Preventiva)</h4>
                        <canvas id="kpi-chart" height="100"></canvas>
                    </section>
                </div>

                <div id="cadastros" class="tab-content hidden">
                    <section>
                        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4>Cadastro de Equipes/T√©cnicos</h4>
                            <div class="actions hidden-print">
                                <button class="btn ghost" id="btn-import-technicians">Importar (CSV)</button>
                                <button class="btn ghost" id="btn-export-technicians">Exportar (CSV)</button>
                            </div>
                        </div>
                        <div style="display:flex; gap:10px; margin-bottom:12px;"><input id="new-technician" placeholder="Nome da equipe/t√©cnico" style="flex-grow:1;"><button id="btn-add-technician" class="btn ghost">Adicionar</button></div>
                        <div style="max-height: 200px; overflow:auto;"><table id="tbl-technicians"><thead><tr><th>Nome</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table></div>
                    </section>
                    <section>
                        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4>Cadastro de Pe√ßas/Componentes</h4>
                            <div class="actions hidden-print">
                                <button class="btn ghost" id="btn-import-parts">Importar (CSV)</button>
                                <button class="btn ghost" id="btn-export-parts">Exportar (CSV)</button>
                            </div>
                        </div>
                        <div style="display:flex; gap:10px; margin-bottom:12px;"><input id="new-part" placeholder="Nome ou c√≥digo da pe√ßa" style="flex-grow:1;"><button id="btn-add-part" class="btn ghost">Adicionar</button></div>
                        <div style="max-height: 200px; overflow:auto;"><table id="tbl-parts"><thead><tr><th>Nome</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table></div>
                    </section>
                </div>

                <div id="help" class="tab-content hidden">
                    <section>
                        <h2>Guia de Uso - CMMS Lite</h2>
                        <h4>1. Fluxo de Trabalho</h4>
                        <ol>
                            <li><b>M√°quinas:</b> Cadastre todos os seus ativos e m√°quinas, um por um ou via importa√ß√£o CSV.</li>
                            <li><b>Planos Preventivos:</b> Crie rotinas de manuten√ß√£o para suas m√°quinas (ex: lubrifica√ß√£o semanal).</li>
                            <li><b>Ordens de Servi√ßo:</b> Clique em "Nova Ordem de Servi√ßo" para registrar uma manuten√ß√£o n√£o planejada (Corretiva) ou clique em "Gerar OS" em um plano para criar uma Preventiva.</li>
                            <li><b>Atualize o Status:</b> Ao iniciar e concluir uma OS, edite-a e atualize seu status e datas. Isso √© crucial para os KPIs.</li>
                            <li><b>Hist√≥rico:</b> Todas as OS conclu√≠das ou canceladas aparecem aqui.</li>
                            <li><b>KPIs & BI:</b> Acompanhe a sa√∫de da sua manuten√ß√£o com indicadores autom√°ticos como MTTR e MTBF.</li>
                        </ol>
                        <h4>2. Cadastros e Gerenciamento em Massa (CSV)</h4>
                        <p>Nas abas <b>M√°quinas</b> e <b>Cadastros</b>, voc√™ pode usar os bot√µes <b>Importar (CSV)</b> e <b>Exportar (CSV)</b> para gerenciar suas listas de base.</p>
                        <ul>
                            <li><b>Exportar:</b> Salva a lista atual em um arquivo CSV, que pode ser aberto em qualquer editor de planilhas.</li>
                            <li><b>Importar:</b> Adiciona itens de um arquivo CSV √† lista existente. O arquivo deve ter um cabe√ßalho na primeira linha.
                                <ul>
                                    <li><b>M√°quinas:</b> O cabe√ßalho deve ser <code>tag,name,department,installDate</code></li>
                                    <li><b>Equipes/Pe√ßas:</b> O cabe√ßalho deve ser <code>valor</code></li>
                                </ul>
                            </li>
                        </ul>
                        <h4>3. Backup e Seguran√ßa</h4>
                        <p>Use os bot√µes no topo da p√°gina para <b>Baixar um Backup</b> de seguran√ßa de todos os dados em formato .json. Se necess√°rio, pode <b>Restaurar</b> a partir de um desses arquivos. O bot√£o <b>Arquivar e Limpar</b> far√° um backup e depois limpar√° os dados do navegador, ideal para arquivamento peri√≥dico.</p>
                    </section>
                </div>
            `;
        };
        
        const openOsModal = (osId = null) => {
            const wo = osId ? state.workOrders.find(o => o.id == osId) : null;
            const title = wo ? `Ordem de Servi√ßo #${wo.id}` : 'Nova Ordem de Servi√ßo';
            const machineOptions = state.machines.map(m => `<option value="${m.name}" ${wo?.machineName === m.name ? 'selected' : ''}>${m.tag} - ${m.name}</option>`).join('');
            const technicianOptions = state.technicians.map(t => `<option value="${t}" ${wo?.technician === t ? 'selected' : ''}>${t}</option>`).join('');
            const partsOptions = state.parts.map(p => `<option value="${p}" ${wo?.partsUsed?.includes(p) ? 'selected' : ''}>${p}</option>`).join('');
            
            osModal.innerHTML = `
                <div class="modal-content">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>${title}</h3>
                        <button class="btn ghost" id="btn-close-modal" style="padding:5px 8px;">&times;</button>
                    </div>
                    <form id="form-os">
                        <input type="hidden" id="os_id" value="${wo?.id || ''}">
                        <h4>Dados da Solicita√ß√£o</h4>
                        <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div class="field autocomplete-container"><label>M√°quina</label><input id="os_machineName" value="${wo?.machineName || ''}" required></div>
                            <div class="field"><label>Prioridade</label><select id="os_priority">${['Baixa', 'M√©dia', 'Alta', 'Urgente'].map(p => `<option ${wo?.priority === p ? 'selected' : ''}>${p}</option>`).join('')}</select></div>
                            <div class="field"><label>Tipo de Manuten√ß√£o</label><select id="os_type">${['Corretiva', 'Preventiva', 'Melhoria', 'Inspe√ß√£o'].map(t => `<option ${wo?.type === t ? 'selected' : ''}>${t}</option>`).join('')}</select></div>
                        </div>
                        <div class="field" style="margin-top:16px;"><label>Descri√ß√£o do Problema / Servi√ßo</label><textarea id="os_description" rows="3" required>${wo?.description || ''}</textarea></div>
                        
                        <h4 style="margin-top:20px;">Execu√ß√£o e Fechamento</h4>
                        <div class="grid" style="grid-template-columns: repeat(4, 1fr);">
                            <div class="field"><label>Status</label><select id="os_status">${['Aberta', 'Em Andamento', 'Conclu√≠da', 'Cancelada'].map(s => `<option ${wo?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>
                            <div class="field"><label>Equipe / T√©cnico</label><select id="os_technician">${technicianOptions}</select></div>
                            <div class="field"><label>In√≠cio da Execu√ß√£o</label><input id="os_startedAt" type="datetime-local" value="${wo?.startedAt || ''}"></div>
                            <div class="field"><label>Fim da Execu√ß√£o</label><input id="os_completedAt" type="datetime-local" value="${wo?.completedAt || ''}"></div>
                        </div>
                        <div class="field" style="margin-top:16px;"><label>Causa da Falha (se aplic√°vel)</label><input id="os_cause" value="${wo?.cause || ''}"></div>
                        <div class="field" style="margin-top:16px;"><label>Solu√ß√£o Aplicada / Detalhes do Servi√ßo</label><textarea id="os_solution" rows="3">${wo?.solution || ''}</textarea></div>
                        <div class="field" style="margin-top:16px;"><label>Pe√ßas Utilizadas</label><select id="os_partsUsed" multiple>${partsOptions}</select></div>
                        
                        <div style="margin-top:24px; display:flex; justify-content:space-between; align-items:center;">
                             <button type="submit" class="btn primary">Salvar Ordem de Servi√ßo</button>
                             ${wo ? `<button type="button" class="btn ghost" style="color:var(--bad)" id="btn-delete-os" data-id="${wo.id}">Excluir OS</button>` : ''}
                        </div>
                    </form>
                </div>
            `;
            createAutocomplete(osModal.querySelector('#os_machineName'), state.machines);
            osModal.classList.add('active');
        };

        const addEventListeners = () => {
            // Machines
            document.getElementById('form-machine').addEventListener('submit', e => {
                e.preventDefault();
                const id = document.getElementById('machine_id').value;
                const record = {
                    id: id ? parseInt(id) : Date.now(),
                    tag: document.getElementById('machine_tag').value,
                    name: document.getElementById('machine_name').value,
                    department: document.getElementById('machine_department').value,
                    installDate: document.getElementById('machine_installDate').value,
                };
                if(id) state.machines = state.machines.map(m => m.id == id ? record : m);
                else state.machines.push(record);
                saveData();
                renderMachinesList();
                updateRecordCounters();
                showToast('M√°quina salva!', 'success');
                e.target.reset();
                document.getElementById('machine_id').value = '';
            });
            document.getElementById('btn-clear-machine').addEventListener('click', () => {
                document.getElementById('form-machine').reset();
                document.getElementById('machine_id').value = '';
            });
            document.getElementById('tbl-machines').addEventListener('click', e => {
                const id = e.target.dataset.id;
                if(e.target.classList.contains('btn-edit-machine')){
                    const machine = state.machines.find(m => m.id == id);
                    if(machine){
                        document.getElementById('machine_id').value = machine.id;
                        document.getElementById('machine_tag').value = machine.tag;
                        document.getElementById('machine_name').value = machine.name;
                        document.getElementById('machine_department').value = machine.department;
                        document.getElementById('machine_installDate').value = machine.installDate;
                        window.scrollTo(0, 0);
                    }
                }
                if(e.target.classList.contains('btn-delete-machine')){
                    if(confirm('Tem certeza? Isso excluir√° a m√°quina e pode afetar OS associadas.')){
                        state.machines = state.machines.filter(m => m.id != id);
                        saveData();
                        renderMachinesList();
                        updateRecordCounters();
                        showToast('M√°quina exclu√≠da.', 'success');
                    }
                }
            });
            document.getElementById('btn-export-machines').addEventListener('click', () => handleExportCSV(state.machines, 'maquinas.csv', ['tag', 'name', 'department', 'installDate']));
            document.getElementById('btn-import-machines').addEventListener('click', () => handleImportCSV('machines', true, ['tag', 'name', 'department', 'installDate']));

            
            // Preventive Plans
            document.getElementById('form-preventive').addEventListener('submit', e => {
                e.preventDefault();
                const id = document.getElementById('plan_id').value;
                const record = {
                    id: id ? parseInt(id) : Date.now(),
                    machineName: document.getElementById('plan_machineName').value,
                    task: document.getElementById('plan_task').value,
                    frequency: document.getElementById('plan_frequency').value,
                    technician: document.getElementById('plan_technician').value,
                };
                if(id) state.preventivePlans = state.preventivePlans.map(p => p.id == id ? record : p);
                else state.preventivePlans.push(record);
                saveData();
                renderPreventiveList();
                showToast('Plano salvo!', 'success');
                e.target.reset();
                document.getElementById('plan_id').value = '';
            });
            createAutocomplete(document.getElementById('plan_machineName'), state.machines);
            document.getElementById('plan_technician').innerHTML = state.technicians.map(t => `<option>${t}</option>`).join('');
            document.getElementById('btn-clear-plan').addEventListener('click', () => {
                document.getElementById('form-preventive').reset();
                document.getElementById('plan_id').value = '';
            });
            document.getElementById('tbl-preventive').addEventListener('click', e => {
                const id = e.target.dataset.id;
                const plan = state.preventivePlans.find(p => p.id == id);
                if(e.target.classList.contains('btn-edit-plan')){
                    if(plan){
                        document.getElementById('plan_id').value = plan.id;
                        document.getElementById('plan_machineName').value = plan.machineName;
                        document.getElementById('plan_task').value = plan.task;
                        document.getElementById('plan_frequency').value = plan.frequency;
                        document.getElementById('plan_technician').value = plan.technician;
                        window.scrollTo(0, 0);
                    }
                }
                if(e.target.classList.contains('btn-delete-plan')){
                    if(confirm('Tem certeza?')){
                        state.preventivePlans = state.preventivePlans.filter(p => p.id != id);
                        saveData();
                        renderPreventiveList();
                        showToast('Plano exclu√≠do.', 'success');
                    }
                }
                if(e.target.classList.contains('btn-gen-os')){
                     if(plan){
                        const newOs = {
                            id: `OS-${Date.now()}`,
                            machineName: plan.machineName,
                            description: `Preventiva: ${plan.task}`,
                            type: 'Preventiva',
                            priority: 'M√©dia',
                            status: 'Aberta',
                            createdAt: new Date().toISOString(),
                            createdBy: localStorage.getItem(USER_KEY),
                            technician: plan.technician,
                        };
                        state.workOrders.push(newOs);
                        saveData();
                        renderWorkOrdersList('tbl-workorders', wo => wo.status !== 'Conclu√≠da' && wo.status !== 'Cancelada');
                        updateRecordCounters();
                        showToast(`OS ${newOs.id} gerada com sucesso!`, 'success');
                     }
                }
            });

            // Work Orders
            document.getElementById('btn-new-os').addEventListener('click', () => openOsModal());
            document.getElementById('tbl-workorders').addEventListener('click', e => {
                if(e.target.classList.contains('btn-view-os')) openOsModal(e.target.dataset.id);
            });
            document.getElementById('tbl-history').addEventListener('click', e => {
                if(e.target.classList.contains('btn-view-os')) openOsModal(e.target.dataset.id);
            });
            osModal.addEventListener('click', e => {
                if(e.target.id === 'btn-close-modal') osModal.classList.remove('active');
                if(e.target.classList.contains('btn-delete-os')){
                    const id = e.target.dataset.id;
                    if(confirm(`Tem certeza que deseja excluir a OS #${id}?`)){
                        state.workOrders = state.workOrders.filter(wo => wo.id != id);
                        saveData();
                        renderWorkOrdersList('tbl-workorders', wo => wo.status !== 'Conclu√≠da' && wo.status !== 'Cancelada');
                        renderWorkOrdersList('tbl-history', wo => wo.status === 'Conclu√≠da' || wo.status === 'Cancelada');
                        updateRecordCounters();
                        osModal.classList.remove('active');
                        showToast('OS exclu√≠da.', 'success');
                    }
                }
            });
            osModal.addEventListener('submit', e => {
                if(e.target.id === 'form-os'){
                    e.preventDefault();
                    const id = document.getElementById('os_id').value;
                    let record = {
                        machineName: document.getElementById('os_machineName').value,
                        priority: document.getElementById('os_priority').value,
                        type: document.getElementById('os_type').value,
                        description: document.getElementById('os_description').value,
                        status: document.getElementById('os_status').value,
                        technician: document.getElementById('os_technician').value,
                        startedAt: document.getElementById('os_startedAt').value,
                        completedAt: document.getElementById('os_completedAt').value,
                        cause: document.getElementById('os_cause').value,
                        solution: document.getElementById('os_solution').value,
                        partsUsed: Array.from(document.getElementById('os_partsUsed').selectedOptions).map(o => o.value),
                    };
                    
                    if(id){ // Editing
                        const original = state.workOrders.find(wo => wo.id == id);
                        record = {...original, ...record};
                        state.workOrders = state.workOrders.map(wo => wo.id == id ? record : wo);
                        showToast(`OS #${id} atualizada!`, 'success');
                    } else { // Creating
                        record.id = `OS-${Date.now()}`;
                        record.createdAt = new Date().toISOString();
                        record.createdBy = localStorage.getItem(USER_KEY);
                        state.workOrders.push(record);
                        showToast(`OS #${record.id} criada!`, 'success');
                    }
                    saveData();
                    renderWorkOrdersList('tbl-workorders', wo => wo.status !== 'Conclu√≠da' && wo.status !== 'Cancelada');
                    renderWorkOrdersList('tbl-history', wo => wo.status === 'Conclu√≠da' || wo.status === 'Cancelada');
                    updateRecordCounters();
                    osModal.classList.remove('active');
                }
            });
            
            // Cadastros
            document.getElementById('btn-add-technician').addEventListener('click', () => {
                const input = document.getElementById('new-technician');
                if(input.value.trim()){ state.technicians.push(input.value.trim()); saveData(); renderCadastros(); input.value='';}
            });
             document.getElementById('btn-add-part').addEventListener('click', () => {
                const input = document.getElementById('new-part');
                if(input.value.trim()){ state.parts.push(input.value.trim()); saveData(); renderCadastros(); input.value='';}
            });
            document.getElementById('btn-export-technicians').addEventListener('click', () => handleExportCSV(state.technicians, 'tecnicos.csv'));
            document.getElementById('btn-import-technicians').addEventListener('click', () => handleImportCSV('technicians', false));
            document.getElementById('btn-export-parts').addEventListener('click', () => handleExportCSV(state.parts, 'pecas.csv'));
            document.getElementById('btn-import-parts').addEventListener('click', () => handleImportCSV('parts', false));

        };

        const initApp = () => {
            loadData();
            const savedUser = localStorage.getItem(USER_KEY);
            if (savedUser) {
                setCurrentUser(savedUser);
                renderAll();
                openTab({currentTarget: document.querySelector('.menu a')}, 'dashboard');
            } else {
                loginModal.classList.add('active');
            }
        };
        
        // Global Event Listeners
        document.getElementById('login-form').addEventListener('submit', e => {
            e.preventDefault();
            const name = document.getElementById('analyst-name-input').value.trim();
            if(name) {
                setCurrentUser(name);
                showToast(`Bem-vindo, ${name}!`, 'success');
                renderAll();
                openTab({currentTarget: document.querySelector('.menu a')}, 'dashboard');
            }
        });
        
        document.getElementById('btn-switch-user').addEventListener('click', () => { localStorage.removeItem(USER_KEY); window.location.reload(); });
        document.getElementById('btn-download-backup').addEventListener('click', () => { const blob = new Blob([JSON.stringify(state, null, 2)],{type:'application/json'}); const l=document.createElement("a");l.href=URL.createObjectURL(blob);l.download=`cmms_backup_${new Date().toISOString().slice(0,10)}.json`;l.click();URL.revokeObjectURL(l.href);showToast("Backup baixado!","success"); });
        document.getElementById('btn-restore-backup').addEventListener('click', () => { const i=document.createElement('input'); i.type='file';i.accept='.json';i.onchange=e=>{const r=new FileReader();r.onload=ev=>{if(!confirm('Restaurar um backup substituir√° TODOS os dados atuais. Continuar?'))return;try{const d=JSON.parse(ev.target.result);state=d;saveData();showToast('Backup restaurado!', 'success');setTimeout(() => window.location.reload(), 1000);}catch(err){showToast('Erro: Arquivo de backup inv√°lido.','error');}};r.readAsText(e.target.files[0]);};i.click();});
        document.getElementById('btn-archive-and-clear').addEventListener('click', () => { if (confirm("ATEN√á√ÉO: Isso ir√° baixar um backup e APAGAR os dados do navegador. Deseja continuar?")) { document.getElementById('btn-download-backup').click(); localStorage.removeItem(DB_KEY); localStorage.removeItem(USER_KEY); showToast("Dados arquivados e limpos.", "info"); setTimeout(() => window.location.reload(), 1500); } });
        document.getElementById('btn-export-pdf').addEventListener('click', () => { window.print(); });
        
        initApp();
    });<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eng Process & Quality - CMMS Lite (Manuten√ß√£o)</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
      :root{--bg:#0f172a;--panel:#111827;--muted:#1f2937;--card:#0b1220;--text:#e5e7eb;--accent:#22d3ee;--accent2:#a78bfa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:16px;}
      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial;background:linear-gradient(120deg,#0b1020,#0a1328);color:var(--text);display:grid;grid-template-columns:280px 1fr;grid-template-rows:auto 1fr;gap:0;}
      header{grid-column:1/3;display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:linear-gradient(90deg,#0b1020,#0a1a35);border-bottom:1px solid #1e293b;position:sticky;top:0;z-index:5}
      .header-title h1{margin:0;font-size:20px;letter-spacing:.4px;color:var(--text);}.header-title .subtitle{margin:4px 0 0 0;font-size:14px;font-weight:normal;color:var(--accent);}.header-title .dev-credit{margin:4px 0 0 0;font-size:11px;font-weight:normal;color:#64748b;}
      header .actions{display:flex;flex-wrap:wrap;gap:8px}
      button, .btn{background:var(--muted);color:var(--text);border:1px solid #243041;border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow:var(--shadow);transition:.2s;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:8px;}
      button:hover, .btn:hover{transform:translateY(-1px);border-color:#334155}
      button.primary{background:linear-gradient(180deg,#0ea5e9,#2563eb);border-color:transparent}
      button.ghost{background:transparent;border-color:#334155}
      aside{border-right:1px solid #1f2937;background:linear-gradient(180deg,#0b1020,#0a1328);padding:16px;display:flex;flex-direction:column;gap:24px;justify-content:space-between; overflow-y: auto;}
      .menu{display:flex;flex-direction:column;gap:8px}
      .menu a{display:flex;gap:10px;align-items:center;text-decoration:none;color:#cbd5e1;padding:10px 12px;border:1px solid #1e293b;border-radius:12px;background:rgba(255,255,255,.02);cursor:pointer;}
      .menu a.active, .menu a:hover{border-color:#334155;background:rgba(34,211,238,.08);color:#e2e8f0}
      main{padding:18px;overflow:auto}
      .hidden, .tab-content.hidden{display:none !important}
      section{background:rgba(255,255,255,.03);border:1px solid #1f2937;border-radius:var(--radius);padding:20px;margin-bottom:20px;box-shadow:var(--shadow)}
      h2, h3, h4{margin:0 0 12px 0;color:var(--accent);} h4{color:var(--accent2)}
      .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));}
      .field{display:flex;flex-direction:column;gap:6px}
      label{font-size:12px;color:#93c5fd}
      input, select, textarea{background:#0b1220;border:1px solid #243041;color:var(--text);padding:10px 12px;border-radius:10px;outline:none;font-family:inherit;font-size:14px;min-height:44px}
      table{width:100%;border-collapse:collapse;} th, td{padding:10px 12px;border-bottom:1px solid var(--muted);text-align:left;font-size:13px;vertical-align:middle;} th{background:rgba(255,255,255,.05);font-size:12px;color:#94a3b8;}
      .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;}
      .kpi-card{background:var(--card);border-radius:12px;padding:16px;text-align:center;}
      .kpi-card h3{font-size:12px;color:var(--accent2);margin:0 0 8px 0;font-weight:normal;text-transform:uppercase;}
      .kpi-card .kpi-value{font-size:2.25rem;font-weight:bold;color:var(--accent);}
      #record-counter{background:rgba(255,255,255,.02);border:1px solid #1e293b;border-radius:12px;padding:12px;} #record-counter p{margin:8px 0;color:#cbd5e1;display:flex;justify-content:space-between;} #record-counter span{font-weight:bold;color:var(--accent);}
      .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:100;display:none;justify-content:center;align-items:center;padding:16px;}
      .modal.active{display:flex;}
      .modal-content{background:var(--bg);padding:24px;border-radius:16px;width:90%;max-width:800px;border:1px solid var(--muted);max-height:90vh;overflow-y:auto;}
      .toast-container{position:fixed;top:20px;right:20px;z-index:200;display:flex;flex-direction:column;gap:10px;}
      .toast{padding:12px 18px;border-radius:12px;color:white;font-weight:600;font-size:14px;box-shadow:var(--shadow);opacity:0;transform:translateX(100%);transition:all 0.4s ease;}
      .toast.show{opacity:1;transform:translateX(0);}.toast.success{background:linear-gradient(90deg,#22c55e,#16a34a);}.toast.error{background:linear-gradient(90deg,#ef4444,#dc2626);}.toast.info{background:linear-gradient(90deg,#3b82f6,#2563eb);}
      .status-pill{padding:.2rem .6rem;border-radius:99px;font-weight:600;font-size:.75rem;color:white;display:inline-block;text-align:center;}
      .autocomplete-container { position: relative; }
      .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; z-index: 10; background: var(--panel); border: 1px solid var(--muted); border-radius: 10px; max-height: 200px; overflow-y: auto; margin-top: 4px; }
      .autocomplete-item { padding: 10px 12px; cursor: pointer; font-size: 14px; text-align: left; }
      .autocomplete-item:hover { background: var(--muted); }
      .autocomplete-item.is-new { font-style: italic; color: var(--accent); }
      @media print{body{grid-template-columns:1fr;color:#000;background:#fff;}header,aside,.hidden-print,.btn,.modal{display:none!important;}main{padding:0;overflow:visible;}section{border:1px solid #ccc;box-shadow:none;background:#fff;page-break-inside:avoid;}h2,h3,h4,label,p,span{color:black !important;}}
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <header>
        <div class="header-title"><h1>Eng Process & Quality</h1><p class="subtitle">CMMS Lite (Gest√£o de Manuten√ß√£o)</p><p class="dev-credit">Desenvolvido por Marcos Gar√ßon</p></div>
        <div class="actions">
            <button class="btn ghost" id="btn-restore-backup">Restaurar Backup</button>
            <button class="btn ghost" id="btn-download-backup">Baixar Backup (.json)</button>
            <button class="btn ghost" id="btn-archive-and-clear" style="color:var(--warn);">Arquivar e Limpar</button>
            <button class="btn primary hidden-print" id="btn-export-pdf">Exportar PDF</button>
        </div>
    </header>
    <aside>
        <div>
            <div class="menu">
                <a href="#" class="tab-link active" onclick="openTab(event, 'dashboard')"><i class="ph-bold ph-gauge"></i> Dashboard</a>
                <a href="#" class="tab-link" onclick="openTab(event, 'machines')"><i class="ph-bold ph-robot"></i> M√°quinas</a>
                <a href="#" class="tab-link" onclick="openTab(event, 'preventive')"><i class="ph-bold ph-calendar-check"></i> Planos Preventivos</a>
                <a href="#" class="tab-link" onclick="openTab(event, 'workorders')"><i class="ph-bold ph-wrench"></i> Ordens de Servi√ßo</a>
                <a href="#" class="tab-link" onclick="openTab(event, 'history')"><i class="ph-bold ph-archive"></i> Hist√≥rico</a>
                <a href="#" class="tab-link" onclick="openTab(event, 'kpis')"><i class="ph-bold ph-chart-line-up"></i> KPIs & BI</a>
                <a href="#" class="tab-link" onclick="openTab(event, 'cadastros')">üó≥Ô∏è Cadastros</a>
                <a href="#" class="tab-link" onclick="openTab(event, 'help')"><i class="ph-bold ph-question"></i> Ajuda</a>
            </div>
        </div>
        <div id="record-counter">
             <p>M√°quinas: <span id="machine-count">0</span></p>
             <p>Ordens Abertas: <span id="open-os-count">0</span></p>
        </div>
    </aside>
    <main id="main-content">
        </main>
    
    <div id="os-modal" class="modal"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let state = {};
        const DB_KEY = 'mg_cmms_v3';
        let kpiChart = null;
        let dashboardChart = null;

        const main = document.getElementById('main-content');
        const osModal = document.getElementById('os-modal');
        
        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container'); if(!container) return;
            const toast = document.createElement('div');
            toast.className = `toast ${type}`; toast.textContent = message; container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 4000);
        };
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return isNaN(date.getTime()) ? 'N/A' : new Date(date.valueOf() + date.getTimezoneOffset() * 60 * 1000).toLocaleDateString('pt-BR');
        };
        const formatDateTime = (dateString) => dateString ? new Date(dateString).toLocaleString('pt-BR') : 'N/A';
        const getStatusPill = (status) => {
            const colors = { Aberta: '#ef4444', 'Em Andamento': '#f59e0b', Conclu√≠da: '#22c55e', Cancelada: '#6b7280' };
            return `<span class="status-pill" style="background-color:${colors[status] || '#6b7280'}">${status}</span>`;
        };

        const saveData = () => { try { localStorage.setItem(DB_KEY, JSON.stringify(state)); } catch (e) { showToast('Erro ao salvar dados.', 'error'); } };
        const loadData = () => {
            try {
                const loaded = JSON.parse(localStorage.getItem(DB_KEY));
                state = {
                    machines: loaded?.machines || [],
                    preventivePlans: loaded?.preventivePlans || [],
                    workOrders: loaded?.workOrders || [],
                    technicians: loaded?.technicians || ["Equipe Mec√¢nica", "Equipe El√©trica", "Automa√ß√£o"],
                    parts: loaded?.parts || [],
                };
            } catch (e) {
                state = { machines: [], preventivePlans: [], workOrders: [], technicians: ["Equipe Mec√¢nica", "Equipe El√©trica", "Automa√ß√£o"], parts: [] };
            }
        };
        window.openTab = (evt, tabId) => {
            evt.preventDefault();
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            const el = document.getElementById(tabId);
            if(el) el.classList.remove('hidden');
            document.querySelectorAll('.menu a').forEach(link => link.classList.remove('active'));
            if(evt.currentTarget) evt.currentTarget.classList.add('active');
            if (tabId === 'kpis') renderKpiPage();
            if (tabId === 'dashboard') renderDashboard();
        };

        const handleExportCSV = (dataArray, filename, headers) => {
            if (!dataArray || dataArray.length === 0) return showToast('N√£o h√° dados para exportar.', 'info');
            const isComplex = Array.isArray(headers);
            let csvContent = "data:text/csv;charset=utf-8,";
            if (isComplex) {
                csvContent += headers.join(',') + '\r\n';
                dataArray.forEach(item => { const row = headers.map(header => `"${item[header] || ''}"`).join(','); csvContent += row + '\r\n'; });
            } else {
                csvContent += 'valor\r\n';
                dataArray.forEach(item => { csvContent += `"${item}"\r\n`; });
            }
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", filename);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
            showToast('Dados exportados!', 'success');
        };

        const handleImportCSV = (stateKey, isComplex, expectedHeaders) => {
            const input = document.createElement('input'); input.type = 'file'; input.accept = '.csv';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    if (!confirm(`Isso ir√° ADICIONAR os dados do CSV √† lista atual de "${stateKey}". Deseja continuar?`)) return;
                    try {
                        const text = event.target.result; const lines = text.trim().split(/\r\n|\n/);
                        const headerLine = lines.shift().split(',').map(h => h.trim().replace(/"/g, ''));
                        if (isComplex && JSON.stringify(headerLine) !== JSON.stringify(expectedHeaders)) { return showToast(`Erro: Cabe√ßalho do CSV inv√°lido. Esperado: ${expectedHeaders.join(',')}`, 'error'); }
                        let importedCount = 0;
                        lines.forEach(line => {
                           const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                           if(values.length === 0 || (values.length === 1 && values[0] === '')) return;
                           if (isComplex) { let obj = { id: Date.now() + importedCount }; expectedHeaders.forEach((header, index) => { obj[header] = values[index] || ''; }); state[stateKey].push(obj); }
                           else { state[stateKey].push(values[0]); }
                           importedCount++;
                        });
                        saveData(); renderAll(); showToast(`${importedCount} itens importados com sucesso!`, 'success');
                    } catch (err) { showToast('Erro ao processar o arquivo CSV.', 'error'); console.error(err); }
                };
                reader.readAsText(file);
            };
            input.click();
        };

        const createAutocomplete = (input, dataArray) => {
            const container = input.parentElement; let list = container.querySelector('.autocomplete-list');
            if (!list) { list = document.createElement('div'); list.className = 'autocomplete-list hidden'; container.appendChild(list); }
            const renderList = (filter = '') => {
                list.innerHTML = ''; const filterLower = filter.toLowerCase();
                if (!filter) { list.classList.add('hidden'); return; }
                const matches = dataArray.filter(item => item.name.toLowerCase().includes(filterLower));
                matches.forEach(item => { const itemEl = document.createElement('div'); itemEl.className = 'autocomplete-item'; itemEl.textContent = `${item.name} (${item.tag})`; itemEl.addEventListener('mousedown', () => { input.value = item.name; list.classList.add('hidden'); }); list.appendChild(itemEl); });
                list.classList.toggle('hidden', list.children.length === 0);
            };
            input.addEventListener('input', () => renderList(input.value)); input.addEventListener('focus', () => renderList(input.value)); input.addEventListener('blur', () => setTimeout(() => list.classList.add('hidden'), 200));
        };

        const calculateOEE = (order) => {
            const { logs = [], idealCycleTime = 0, downtime = 0 } = order;
            if (!logs.length || !idealCycleTime) return { oee: 0, availability: 0, performance: 0, quality: 0 };
            const firstLog = logs[0]; const lastLog = logs[logs.length - 1];
            const plannedTime = (new Date(lastLog.timestamp) - new Date(firstLog.timestamp)) / (1000 * 60);
            if (plannedTime <= 0) return { oee: 0, availability: 0, performance: 0, quality: 0 };
            const operatingTime = plannedTime - downtime; const availability = (operatingTime / plannedTime);
            const totalProduced = lastLog.totalCounter; const totalScrap = logs.reduce((acc, log) => acc + (log.scrap || 0), 0);
            const goodParts = totalProduced - totalScrap; const quality = totalProduced > 0 ? (goodParts / totalProduced) : 0;
            const idealTimeForProduction = (totalProduced * idealCycleTime) / 60;
            const performance = operatingTime > 0 ? (idealTimeForProduction / operatingTime) : 0;
            const oee = availability * performance * quality;
            return { oee: oee * 100, availability: availability * 100, performance: performance * 100, quality: quality * 100 };
        };

        const renderMachinesList = () => { const tbody = document.getElementById('tbl-machines'); if (!tbody) return; tbody.innerHTML = ''; state.machines.forEach(m => { const tr = tbody.insertRow(); tr.innerHTML = `<td>${m.tag}</td><td>${m.name}</td><td>${m.department}</td><td>${formatDate(m.installDate)}</td>`; const actionsCell = tr.insertCell(); actionsCell.innerHTML = `<button class="btn ghost btn-edit-machine" data-id="${m.id}">Editar</button> <button class="btn ghost btn-delete-machine" data-id="${m.id}" style="color:var(--bad)">Excluir</button>`; }); };
        const renderPreventiveList = () => { const tbody = document.getElementById('tbl-preventive'); if (!tbody) return; tbody.innerHTML = ''; state.preventivePlans.forEach(p => { const tr = tbody.insertRow(); tr.innerHTML = `<td>${p.machineName}</td><td>${p.task}</td><td>${p.frequency}</td><td>${p.technician}</td>`; const actionsCell = tr.insertCell(); actionsCell.innerHTML = `<button class="btn ghost btn-gen-os" data-id="${p.id}">Gerar OS</button> <button class="btn ghost btn-edit-plan" data-id="${p.id}">Editar</button> <button class="btn ghost btn-delete-plan" data-id="${p.id}" style="color:var(--bad)">Excluir</button>`; }); };
        const renderWorkOrdersList = (tableId, filterFn) => { const tbody = document.getElementById(tableId); if (!tbody) return; tbody.innerHTML = ''; state.workOrders.filter(filterFn).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(wo => { const tr = tbody.insertRow(); tr.innerHTML = `<td>${wo.id}</td><td>${wo.machineName}</td><td>${wo.description}</td><td>${wo.type}</td><td>${wo.priority}</td><td>${getStatusPill(wo.status)}</td><td>${formatDateTime(wo.createdAt)}</td>`; const actionsCell = tr.insertCell(); actionsCell.innerHTML = `<button class="btn ghost btn-view-os" data-id="${wo.id}">Ver/Editar</button>`; }); };
        const renderCadastros = () => { const renderList = (key, tableId) => { const tbody = document.querySelector(`#${tableId} tbody`); if(!tbody) return; tbody.innerHTML = ''; state[key].forEach((item, index) => { const tr = tbody.insertRow(); tr.insertCell().textContent = item; tr.insertCell().innerHTML = `<button class="btn ghost" onclick="deleteCadItem('${key}', ${index})">Excluir</button>`; }); }; renderList('technicians', 'tbl-technicians'); renderList('parts', 'tbl-parts'); };
        window.deleteCadItem = (key, index) => { if(confirm(`Tem certeza que deseja excluir este item?`)){ state[key].splice(index, 1); saveData(); renderAll(); showToast('Item exclu√≠do.', 'success'); }};
        const updateRecordCounters = () => { document.getElementById('machine-count').textContent = state.machines.length; document.getElementById('open-os-count').textContent = state.workOrders.filter(wo => wo.status === 'Aberta' || wo.status === 'Em Andamento').length; };
        
        const renderDashboard = () => {
            const openOrders = state.workOrders.filter(wo => wo.status === 'Aberta').length;
            const inProgressOrders = state.workOrders.filter(wo => wo.status === 'Em Andamento').length;
            const completedLast7Days = state.workOrders.filter(wo => wo.status === 'Conclu√≠da' && new Date(wo.completedAt) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)).length;
            document.getElementById('kpi-open').textContent = openOrders;
            document.getElementById('kpi-progress').textContent = inProgressOrders;
            document.getElementById('kpi-completed').textContent = completedLast7Days;

            const ctx = document.getElementById('dashboard-chart')?.getContext('2d'); if (!ctx) return;
            const osByDay = state.workOrders.reduce((acc, wo) => { const date = new Date(wo.createdAt).toISOString().slice(0, 10); acc[date] = (acc[date] || 0) + 1; return acc; }, {});
            const sortedDates = Object.keys(osByDay).sort((a,b) => new Date(a) - new Date(b));
            if (dashboardChart) dashboardChart.destroy();
            dashboardChart = new Chart(ctx, { type: 'line', data: { labels: sortedDates, datasets: [{ label: 'Ordens de Servi√ßo Criadas', data: sortedDates.map(date => osByDay[date]), borderColor: 'var(--accent)', backgroundColor: 'rgba(34, 211, 238, 0.2)', fill: true, tension: 0.3 }] }, options: { scales: { x: { type: 'time', time: { unit: 'day' } }, y: { beginAtZero: true } } } });
        };
        
        const renderKpiPage = () => {
            const completedCorrective = state.workOrders.filter(wo => wo.status === 'Conclu√≠da' && wo.type === 'Corretiva' && wo.startedAt && wo.completedAt);
            let totalRepairTime = 0; completedCorrective.forEach(wo => { totalRepairTime += new Date(wo.completedAt) - new Date(wo.startedAt); });
            const mttrMs = completedCorrective.length > 0 ? totalRepairTime / completedCorrective.length : 0;
            const mttrHours = (mttrMs / (1000 * 60 * 60)).toFixed(2);
            document.getElementById('kpi-mttr').textContent = `${mttrHours} h`;

            const osByMachine = {}; completedCorrective.forEach(wo => { if (!osByMachine[wo.machineName]) osByMachine[wo.machineName] = []; osByMachine[wo.machineName].push(wo); });
            let totalOpTime = 0; let failureCount = 0;
            Object.values(osByMachine).forEach(machineOs => {
                if (machineOs.length < 2) return;
                machineOs.sort((a,b) => new Date(a.completedAt) - new Date(b.completedAt));
                for (let i = 0; i < machineOs.length - 1; i++) {
                    const opTime = new Date(machineOs[i+1].createdAt) - new Date(machineOs[i].completedAt);
                    if (opTime > 0) { totalOpTime += opTime; failureCount++; }
                }
            });
            const mtbfMs = failureCount > 0 ? totalOpTime / failureCount : 0; const mtbfHours = (mtbfMs / (1000 * 60 * 60)).toFixed(2);
            document.getElementById('kpi-mtbf').textContent = `${mtbfHours} h`;
            
            const availability = (mtbfMs > 0 || mttrMs > 0) ? (mtbfMs / (mtbfMs + mttrMs)) * 100 : 0;
            document.getElementById('kpi-availability').textContent = `${availability.toFixed(2)}%`;
            
            const ctx = document.getElementById('kpi-chart')?.getContext('2d'); if(!ctx) return;
            const correctiveByMonth = completedCorrective.reduce((acc, wo) => { const month = new Date(wo.createdAt).toISOString().slice(0,7); acc[month] = (acc[month] || 0) + 1; return acc; }, {});
            const preventiveByMonth = state.workOrders.filter(wo => wo.status === 'Conclu√≠da' && wo.type === 'Preventiva').reduce((acc, wo) => { const month = new Date(wo.createdAt).toISOString().slice(0,7); acc[month] = (acc[month] || 0) + 1; return acc; }, {});
            const allMonths = [...new Set([...Object.keys(correctiveByMonth), ...Object.keys(preventiveByMonth)])].sort();
            
            if (kpiChart) kpiChart.destroy();
            kpiChart = new Chart(ctx, { type: 'bar', data: { labels: allMonths, datasets: [ { label: 'Corretivas Conclu√≠das', data: allMonths.map(m => correctiveByMonth[m] || 0), backgroundColor: 'var(--bad)'}, { label: 'Preventivas Conclu√≠das', data: allMonths.map(m => preventiveByMonth[m] || 0), backgroundColor: 'var(--ok)' } ] }, options: { scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } } });
        };
        
        const renderAll = () => { main.innerHTML = createViewsHTML(); addEventListeners(); renderDashboard(); renderMachinesList(); renderPreventiveList(); renderWorkOrdersList('tbl-workorders', wo => wo.status !== 'Conclu√≠da' && wo.status !== 'Cancelada'); renderWorkOrdersList('tbl-history', wo => wo.status === 'Conclu√≠da' || wo.status === 'Cancelada'); renderCadastros(); updateRecordCounters(); };

        const createViewsHTML = () => { /* ... (mesmo c√≥digo HTML do seu arquivo original) ... */ return `...`; }; // O HTML √© injetado aqui
        
        const openOsModal = (osId = null) => {
            const wo = osId ? state.workOrders.find(o => o.id == osId) : null;
            const title = wo ? `Ordem de Servi√ßo #${wo.id}` : 'Nova Ordem de Servi√ßo';
            const technicianOptions = state.technicians.map(t => `<option value="${t}" ${wo?.technician === t ? 'selected' : ''}>${t}</option>`).join('');
            const partsOptions = state.parts.map(p => `<option value="${p}" ${wo?.partsUsed?.includes(p) ? 'selected' : ''}>${p}</option>`).join('');
            
            osModal.innerHTML = `
                <div class="modal-content">
                    <div style="display:flex; justify-content:space-between; align-items:center;"><h3>${title}</h3><button class="btn ghost" id="btn-close-modal" style="padding:5px 8px;">&times;</button></div>
                    <form id="form-os">
                        <input type="hidden" id="os_id" value="${wo?.id || ''}">
                        <h4>Dados da Solicita√ß√£o</h4>
                        <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div class="field autocomplete-container"><label>M√°quina</label><input id="os_machineName" value="${wo?.machineName || ''}" required></div>
                            <div class="field"><label>Prioridade</label><select id="os_priority">${['Baixa', 'M√©dia', 'Alta', 'Urgente'].map(p => `<option ${wo?.priority === p ? 'selected' : ''}>${p}</option>`).join('')}</select></div>
                            <div class="field"><label>Tipo de Manuten√ß√£o</label><select id="os_type">${['Corretiva', 'Preventiva', 'Melhoria', 'Inspe√ß√£o'].map(t => `<option ${wo?.type === t ? 'selected' : ''}>${t}</option>`).join('')}</select></div>
                        </div>
                        <div class="field" style="margin-top:16px;"><label>Descri√ß√£o do Problema / Servi√ßo</label><textarea id="os_description" rows="3" required>${wo?.description || ''}</textarea></div>
                        
                        <h4 style="margin-top:20px;">Execu√ß√£o e Fechamento</h4>
                        <div class="grid" style="grid-template-columns: repeat(4, 1fr);">
                            <div class="field"><label>Status</label><select id="os_status">${['Aberta', 'Em Andamento', 'Conclu√≠da', 'Cancelada'].map(s => `<option ${wo?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>
                            <div class="field"><label>Equipe / T√©cnico</label><select id="os_technician">${technicianOptions}</select></div>
                            <div class="field"><label>In√≠cio da Execu√ß√£o</label><input id="os_startedAt" type="datetime-local" value="${wo?.startedAt || ''}"></div>
                            <div class="field"><label>Fim da Execu√ß√£o</label><input id="os_completedAt" type="datetime-local" value="${wo?.completedAt || ''}"></div>
                        </div>
                        <div class="field" style="margin-top:16px;"><label>Causa da Falha (se aplic√°vel)</label><input id="os_cause" value="${wo?.cause || ''}"></div>
                        <div class="field" style="margin-top:16px;"><label>Solu√ß√£o Aplicada / Detalhes do Servi√ßo</label><textarea id="os_solution" rows="3">${wo?.solution || ''}</textarea></div>
                        <div class="field" style="margin-top:16px;"><label>Pe√ßas Utilizadas</label><select id="os_partsUsed" multiple>${partsOptions}</select></div>
                        
                        <div style="margin-top:24px; display:flex; justify-content:space-between; align-items:center;">
                             <button type="submit" class="btn primary">Salvar Ordem de Servi√ßo</button>
                             ${wo ? `<button type="button" class="btn ghost" style="color:var(--bad)" id="btn-delete-os" data-id="${wo.id}">Excluir OS</button>` : ''}
                        </div>
                    </form>
                </div>
            `;
            createAutocomplete(osModal.querySelector('#os_machineName'), state.machines);
            osModal.classList.add('active');
        };

        const addEventListeners = () => { /* ... (c√≥digo dos event listeners inalterado) ... */ };
        
        // --- INIT ---
        const initApp = () => {
            loadData();
            main.innerHTML = createViewsHTML();
            addEventListeners();
            renderAll();
            openTab({currentTarget: document.querySelector('.menu a'), preventDefault: () => {}}, 'dashboard');
        };
        
        // --- GLOBAL EVENT LISTENERS ---
        document.getElementById('btn-download-backup').addEventListener('click', () => { /* ... */ });
        document.getElementById('btn-restore-backup').addEventListener('click', () => { /* ... */ });
        document.getElementById('btn-archive-and-clear').addEventListener('click', () => { /* ... */ });
        document.getElementById('btn-export-pdf').addEventListener('click', () => { window.print(); });
        
        initApp();
    });
    </script>
</body>
</html>
    </script>
</body>
</html>